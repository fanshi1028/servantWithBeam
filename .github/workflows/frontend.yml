name: "Frontend Build"
on:
  pull_request:
  push:
jobs:
    frontend-js:
        name: frontend/js/${{matrix.release}}/ghc${{matrix.ghc}}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest]
                # seems 884 is fucked up by TH
                ghc: [865]
                sedArg: ["", "''"]
                release: ["linux", "osx", "windows"]
                exclude:
                  - os: ubuntu-latest
                    sedArg: "''"
                  - os: macos-latest
                    sedArg: ""
                    # no osx on ubuntu
                  - os: ubuntu-latest
                    release: "osx"
                    # only osx on macos
                  - os: macos-latest
                    release: "linux"
                  - os: macos-latest
                    release: "windows"

        runs-on: ${{matrix.os}}
        if: ${{ !contains(github.event.head_commit.message, '[backend]') && !contains(github.event.head_commit.message, '[native]') && !contains(github.event.head_commit.message, '[mobile]') }}
        steps:
            - uses: actions/checkout@v2.3.4
            - uses: cachix/install-nix-action@v12
            - uses: cachix/cachix-action@v8
              with:
                  name: servant-with-beam
                  authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
            - name: add haskell.nix pub keys, add haskell.nix substituters
              run: |
                sed -i ${{matrix.sedArg}} '/^trusted-public-keys =/ s/$/ hydra.iohk.io:f\/Ea+s+dFdN+3Y\/G+FDgSq+a5NEWhJGzdjvKNGv0\/EQ=/' ~/.config/nix/nix.conf
                sed -i ${{matrix.sedArg}} '/^substituters =/ s/$/ https:\/\/hydra.iohk.io/' ~/.config/nix/nix.conf
            - name: nix-build
              run: nix-build -j4 --argstr compiler ghc${{matrix.ghc}} --arg default false --arg js true -A servant-with-beam.${{matrix.release}}
            # https://github.com/actions/upload-artifact/issues/92
            # https://github.com/minvws/nl-covid19-notification-app-community-website/blob/0b70c8ed7305fc3ff2e0726b8e1cf32ed39f27fb/.github/workflows/deploy.yml#L15
            # NOTE Workaround for artifacts and deploy not liking symlinks to read-only paths.
            - name: Copy artifacts
              run: |
                mkdir build
                cp -r result/*  build/
                chmod -R +w build/
            - name: upload artifact
              uses: actions/upload-artifact@v2
              with:
                name: frontend-js-${{matrix.release}}-ghc${{matrix.ghc}}
                path: build
            - name: nix-shell
              if: matrix.release == 'osx' && matrix.ghc == '865'
              working-directory: ./frontend
              run: nix-shell -j4

    frontend:
        name: frontend/${{matrix.release}}/ghc${{matrix.ghc}}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest]
                # NOTE: 8104: reflex-dom won't resolve with 8104
                ghc: [865, 884]
                sedArg: ["", "''"]
                # NOTE: windows: unsupported system: x86_64-windows
                release: ["linux", "osx"]
                exclude:
                  - os: ubuntu-latest
                    sedArg: "''"
                  - os: macos-latest
                    sedArg: ""
                    # no osx on ubuntu
                  - os: ubuntu-latest
                    release: "osx"
                    # only osx on macos
                  - os: macos-latest
                    release: "linux"

        runs-on: ${{matrix.os}}
        if: ${{ !contains(github.event.head_commit.message, '[backend]') && !contains(github.event.head_commit.message, '[js]') && !contains(github.event.head_commit.message, '[mobile]') }}
        steps:
            - uses: actions/checkout@v2.3.4
            - uses: cachix/install-nix-action@v12
            - uses: cachix/cachix-action@v8
              with:
                  name: servant-with-beam
                  authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
            - name: add haskell.nix pub keys, add haskell.nix substituters
              run: |
                sed -i ${{matrix.sedArg}} '/^trusted-public-keys =/ s/$/ hydra.iohk.io:f\/Ea+s+dFdN+3Y\/G+FDgSq+a5NEWhJGzdjvKNGv0\/EQ=/' ~/.config/nix/nix.conf
                sed -i ${{matrix.sedArg}} '/^substituters =/ s/$/ https:\/\/hydra.iohk.io/' ~/.config/nix/nix.conf
            - name: nix-build
              run: nix-build -j4 --argstr compiler ghc${{matrix.ghc}} --arg default false --arg frontend true -A servant-with-beam.${{matrix.release}}
            # https://github.com/actions/upload-artifact/issues/92
            # https://github.com/minvws/nl-covid19-notification-app-community-website/blob/0b70c8ed7305fc3ff2e0726b8e1cf32ed39f27fb/.github/workflows/deploy.yml#L15
            # NOTE Workaround for artifacts and deploy not liking symlinks to read-only paths.
            - name: Copy artifacts
              run: |
                mkdir build
                cp -r result/*  build/
                chmod -R +w build/
            - name: upload artifact
              uses: actions/upload-artifact@v2
              with:
                name: frontend-${{matrix.release}}-ghc${{matrix.ghc}}
                path: build

    frontend-mobile:
        name: frontend/${{matrix.release}}/ghc${{matrix.ghc}}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest]
                # NOTE: 8104: reflex-dom won't resolve with 8104
                ghc: [865, 884]
                sedArg: ["", "''"]
                release: ["ios", "android"]
                exclude:
                  - os: ubuntu-latest
                    sedArg: "''"
                  - os: macos-latest
                    sedArg: ""
                  - os: ubuntu-latest
                    release: "iphone"
                  - os: macos-latest
                    release: "android"

        runs-on: ${{matrix.os}}
        if: ${{ !contains(github.event.head_commit.message, '[backend]') && !contains(github.event.head_commit.message, '[js]') && !contains(github.event.head_commit.message, '[native]') }}
        steps:
            - uses: actions/checkout@v2.3.4
            - uses: cachix/install-nix-action@v12
            - uses: cachix/cachix-action@v8
              with:
                  name: servant-with-beam
                  authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
            - name: add haskell.nix pub keys, add haskell.nix substituters
              run: |
                sed -i ${{matrix.sedArg}} '/^trusted-public-keys =/ s/$/ ryantrinkle.com-1:JJiAKaRv9mWgpVAz8dwewnZe0AzzEAzPkagE9SP5NWI=/' ~/.config/nix/nix.conf
                sed -i ${{matrix.sedArg}} '/^substituters =/ s/$/ https:\/\/nixcache.reflex-frp.org/' ~/.config/nix/nix.conf
            - name: nix-build
              run: nix-build -j4 --argstr compiler ghc${{matrix.ghc}} --arg default false --arg frontend true -A servant-with-beam.${{matrix.release}}
            # https://github.com/actions/upload-artifact/issues/92
            # https://github.com/minvws/nl-covid19-notification-app-community-website/blob/0b70c8ed7305fc3ff2e0726b8e1cf32ed39f27fb/.github/workflows/deploy.yml#L15
            # NOTE Workaround for artifacts and deploy not liking symlinks to read-only paths.
            - name: Copy artifacts
              run: |
                mkdir build
                cp -r result/*  build/
                chmod -R +w build/
            - name: upload artifact
              uses: actions/upload-artifact@v2
              with:
                name: frontend-${{matrix.release}}-ghc${{matrix.ghc}}
                path: build
