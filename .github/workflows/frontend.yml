name: "Frontend Build"
on:
  pull_request:
  push:
jobs:
    frontend-js:
        name: frontend/js/${{matrix.release}}/ghc${{matrix.ghc}}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest]
                ghc: [865, 884, 8104]
                sedArg: ["", "''"]
                release: ["linux", "osx", "windows"]
                exclude:
                  - os: ubuntu-latest
                    sedArg: "''"
                  - os: macos-latest
                    sedArg: ""
                    # no osx on ubuntu
                  - os: ubuntu-latest
                    release: "osx"
                    # only osx on macos
                  - os: macos-latest
                    release: "linux"
                  - os: macos-latest
                    release: "windows"

        runs-on: ${{matrix.os}}
        if: ${{ !contains(github.event.head_commit.message, '[backend]') }}
        steps:
            - uses: actions/checkout@v2.3.4
            - uses: cachix/install-nix-action@v12
            - uses: cachix/cachix-action@v8
              with:
                  name: servant-with-beam
                  authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
            - name: add haskell.nix pub keys, add haskell.nix substituters
              run: |
                sed -i ${{matrix.sedArg}} '/^trusted-public-keys =/ s/$/ hydra.iohk.io:f\/Ea+s+dFdN+3Y\/G+FDgSq+a5NEWhJGzdjvKNGv0\/EQ=/' ~/.config/nix/nix.conf
                sed -i ${{matrix.sedArg}} '/^substituters =/ s/$/ https:\/\/hydra.iohk.io/' ~/.config/nix/nix.conf
            - name: nix-build
              run: nix-build -j4 --argstr compiler ghc${{matrix.ghc}} --arg default false --arg js true -A servant-with-beam.${{matrix.release}}
            - name: upload artifact
              uses: actions/upload-artifact@v2
              with:
                name: frontend-js-${{matrix.release}}-ghc${{matrix.ghc}}
                path: result*/**/*
            - name: nix-shell
              if: matrix.release == 'osx' && matrix.ghc == '865'
              working-directory: ./frontend
              run: nix-shell -j4

    frontend:
        name: frontend/${{matrix.release}}/ghc${{matrix.ghc}}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest]
                # NOTE: 8104: reflex-dom won't resolve with 8104
                ghc: [865, 884]
                sedArg: ["", "''"]
                # NOTE: windows: unsupported system: x86_64-windows
                release: ["linux", "osx", "iphone", "android"]
                exclude:
                  - os: ubuntu-latest
                    sedArg: "''"
                  - os: macos-latest
                    sedArg: ""
                    # no osx on ubuntu
                  - os: ubuntu-latest
                    release: "osx"
                  - os: ubuntu-latest
                    release: "iphone"
                    # only osx on macos
                  - os: macos-latest
                    release: "android"
                  - os: macos-latest
                    release: "linux"

        runs-on: ${{matrix.os}}
        if: ${{ !contains(github.event.head_commit.message, '[backend]') }}
        steps:
            - uses: actions/checkout@v2.3.4
            - uses: cachix/install-nix-action@v12
            - uses: cachix/cachix-action@v8
              with:
                  name: servant-with-beam
                  authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
            - name: add haskell.nix pub keys, add haskell.nix substituters
              run: |
                sed -i ${{matrix.sedArg}} '/^trusted-public-keys =/ s/$/ hydra.iohk.io:f\/Ea+s+dFdN+3Y\/G+FDgSq+a5NEWhJGzdjvKNGv0\/EQ=/' ~/.config/nix/nix.conf
                sed -i ${{matrix.sedArg}} '/^substituters =/ s/$/ https:\/\/hydra.iohk.io/' ~/.config/nix/nix.conf
            - name: nix-build
              run: nix-build -j4 --argstr compiler ghc${{matrix.ghc}} --arg default false --arg frontend true -A servant-with-beam.${{matrix.release}}
            - name: upload artifact
              uses: actions/upload-artifact@v2
              with:
                name: frontend-${{matrix.release}}-ghc${{matrix.ghc}}
                path: result*/**/*
